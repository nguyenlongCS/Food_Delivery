<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê∆°n H√†ng - Food Delivery</title>
    <link rel="stylesheet" href="cart.css">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1 id="page-title">üì¶ ƒê∆°n H√†ng C·ªßa T√¥i</h1>
            <a href="home.html" class="back-btn">‚Üê Quay L·∫°i</a>
        </div>
    </div>

    <div class="container">
        <div class="cart-container">
            <div id="order-list" class="cart-items">
                <!-- Orders will be loaded here -->
            </div>
            <div id="empty-orders" class="empty-cart" style="display: none;">
                <div class="empty-cart-icon">üì¶</div>
                <h3>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h3>
                <p>H√£y ƒë·∫∑t m√≥n ƒë·ªÉ xem ƒë∆°n h√†ng t·∫°i ƒë√¢y!</p>
                <a href="menu.html" class="continue-shopping">ƒê·∫∑t M√≥n Ngay</a>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        let currentUser = null;

        // Check authentication
        function checkAuth() {
            const user = localStorage.getItem('user');
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = JSON.parse(user);

            // Ki·ªÉm tra role v√† c·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
            if (currentUser.role === 'restaurant') {
                document.getElementById('page-title').innerHTML = 'üìã Qu·∫£n L√Ω ƒê∆°n H√†ng';
                loadRestaurantOrders();
            } else {
                loadUserOrders();
            }
        }

        // Load orders for regular users
        async function loadUserOrders() {
            try {
                const response = await fetch(`${API_BASE_URL}/orders/user/${currentUser.id}`);
                const data = await response.json();
                
                if (data.success && data.orders.length > 0) {
                    displayUserOrders(data.orders);
                } else {
                    showEmptyState();
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showEmptyState();
            }
        }

        // Load orders for restaurant users
        async function loadRestaurantOrders() {
            try {
                const response = await fetch(`${API_BASE_URL}/orders/restaurant/${currentUser.username}`);
                const data = await response.json();
                
                if (data.success && data.orders.length > 0) {
                    displayRestaurantOrders(data.orders);
                } else {
                    showEmptyState();
                }
            } catch (error) {
                console.error('Error loading restaurant orders:', error);
                showEmptyState();
            }
        }

        // Display orders for regular users
        function displayUserOrders(orders) {
            const orderList = document.getElementById('order-list');
            const emptyOrders = document.getElementById('empty-orders');
            
            orderList.style.display = 'block';
            emptyOrders.style.display = 'none';

            orderList.innerHTML = `
                <h2>üìã L·ªãch S·ª≠ ƒê∆°n H√†ng</h2>
                ${orders.map(order => `
                    <div class="cart-item">
                        <div class="item-details">
                            <div class="item-name">M√£ ƒë∆°n: #${order.id}</div>
                            <div style="margin: 5px 0;">
                                <strong>Nh√† h√†ng:</strong> ${order.restaurant || 'N/A'}
                            </div>
                            <div style="margin: 5px 0;">
                                <strong>Ng√†y ƒë·∫∑t:</strong> ${new Date(order.created_at).toLocaleString('vi-VN')}
                            </div>
                            <div style="margin: 5px 0;">
                                <strong>T·ªïng ti·ªÅn:</strong> ${order.total_amount.toLocaleString('vi-VN')} VNƒê
                            </div>
                            <div style="margin: 5px 0;">
                                <strong>Tr·∫°ng th√°i:</strong> 
                                <span class="status-${order.status}">
                                    ${getStatusText(order.status)}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // Display orders for restaurant users
        function displayRestaurantOrders(orders) {
            const orderList = document.getElementById('order-list');
            const emptyOrders = document.getElementById('empty-orders');
            
            orderList.style.display = 'block';
            emptyOrders.style.display = 'none';

            orderList.innerHTML = `
                <h2>üìã ƒê∆°n H√†ng C·∫ßn X·ª≠ L√Ω</h2>
                ${orders.map(order => `
                    <div class="cart-item">
                        <div class="item-details">
                            <div class="item-name">ƒê∆°n h√†ng #${order.id}</div>
                            <div style="margin: 5px 0;">
                                <strong>Kh√°ch h√†ng:</strong> ${order.username}
                            </div>
                            <div style="margin: 5px 0;">
                                <strong>Ng√†y ƒë·∫∑t:</strong> ${new Date(order.created_at).toLocaleString('vi-VN')}
                            </div>
                            <div style="margin: 5px 0;">
                                <strong>T·ªïng ti·ªÅn:</strong> ${order.total_amount.toLocaleString('vi-VN')} VNƒê
                            </div>
                            <div style="margin: 5px 0;">
                                <strong>Tr·∫°ng th√°i:</strong> 
                                <span class="status-${order.status}">
                                    ${getStatusText(order.status)}
                                </span>
                            </div>
                        </div>
                        ${order.status === 'pending' ? `
                            <div class="quantity-controls" style="gap: 10px;">
                                <button class="checkout-btn" onclick="updateOrderStatus(${order.id}, 'confirmed')" style="background: #10ac84; padding: 8px 16px;">
                                    ‚úÖ X√°c Nh·∫≠n
                                </button>
                                <button class="remove-btn" onclick="updateOrderStatus(${order.id}, 'cancelled')" style="padding: 8px 16px;">
                                    ‚ùå H·ªßy ƒê∆°n
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            `;
        }

        // Show empty state
        function showEmptyState() {
            const orderList = document.getElementById('order-list');
            const emptyOrders = document.getElementById('empty-orders');
            
            orderList.style.display = 'none';
            emptyOrders.style.display = 'block';

            if (currentUser.role === 'restaurant') {
                document.querySelector('#empty-orders h3').textContent = 'Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o';
                document.querySelector('#empty-orders p').textContent = 'C√°c ƒë∆°n h√†ng t·ª´ kh√°ch h√†ng s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y!';
                document.querySelector('#empty-orders .continue-shopping').style.display = 'none';
            }
        }

        // Get status text in Vietnamese
        function getStatusText(status) {
            const statusMap = {
                'pending': '‚è≥ Ch·ªù x√°c nh·∫≠n',
                'confirmed': '‚úÖ ƒê√£ x√°c nh·∫≠n', 
                'cancelled': '‚ùå ƒê√£ h·ªßy'
            };
            return statusMap[status] || status;
        }

        // Update order status (for restaurant)
        async function updateOrderStatus(orderId, status) {
            const confirmMessage = status === 'confirmed' ? 
                'B·∫°n c√≥ ch·∫Øc mu·ªën x√°c nh·∫≠n ƒë∆°n h√†ng n√†y?' : 
                'B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?';
            
            if (!confirm(confirmMessage)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });

                const data = await response.json();
                if (data.success) {
                    alert('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!');
                    loadRestaurantOrders(); // Reload orders
                } else {
                    alert(data.message || 'C√≥ l·ªói x·∫£y ra');
                }
            } catch (error) {
                alert('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i');
                console.error('Error updating order status:', error);
            }
        }

        // Initialize page
        checkAuth();
    </script>

    <style>
        .status-pending {
            color: #f39c12;
            font-weight: bold;
        }
        .status-confirmed {
            color: #10ac84;
            font-weight: bold;
        }
        .status-cancelled {
            color: #e74c3c;
            font-weight: bold;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</body>
</html>