<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Th·ª±c ƒê∆°n - Food Delivery</title>
<link rel="stylesheet" href="menu.css">
</head>
<body>
<div class="header">
    <div class="header-content">
        <h1>üçΩÔ∏è Th·ª±c ƒê∆°n ƒê·∫ßy ƒê·ªß</h1>
        <a href="home.html" class="back-btn">‚Üê Quay L·∫°i</a>
    </div>
</div>

<div class="container">
    <div class="menu-controls">
        <div class="search-section">
            <div class="search-icon">üîç</div>
            <input type="text" class="search-box" id="searchInput" placeholder="T√¨m ki·∫øm m√≥n ƒÉn, nh√† h√†ng...">
        </div>

        <div class="filters">
            <div class="filter-group">
                <label class="filter-label">Kho·∫£ng c√°ch</label>
                <select class="filter-select" id="distanceFilter">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="near">G·∫ßn nh·∫•t (&lt; 2km)</option>
                    <option value="medium">Trung b√¨nh (2-5km)</option>
                    <option value="far">Xa (&gt; 5km)</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">S·∫Øp x·∫øp</label>
                <select class="filter-select" id="sortFilter">
                    <option value="popular">B√°n ch·∫°y</option>
                    <option value="rating">ƒê√°nh gi√° cao</option>
                    <option value="price-low">Gi√° th·∫•p ‚Üí cao</option>
                    <option value="price-high">Gi√° cao ‚Üí th·∫•p</option>
                    <option value="distance">Kho·∫£ng c√°ch</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Gi√°</label>
                <select class="filter-select" id="priceFilter">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="budget">Ti·∫øt ki·ªám (&lt; 200k)</option>
                    <option value="medium">Trung b√¨nh (200k-400k)</option>
                    <option value="premium">Cao c·∫•p (&gt; 400k)</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">ƒê√°nh gi√°</label>
                <select class="filter-select" id="ratingFilter">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê+ tr·ªü l√™n</option>
                    <option value="3">‚≠ê‚≠ê‚≠ê+ tr·ªü l√™n</option>
                </select>
            </div>
        </div>
    </div>

    <div class="menu-grid" id="menuGrid">
        <!-- Menu items will be loaded here -->
    </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:5000/api';
    let menuItems = [];
    let filteredItems = [];
    let currentUser = null;

    // Check authentication
    function checkAuth() {
        const user = localStorage.getItem('user');
        if (!user) {
            window.location.href = 'index.html';
            return;
        }
        currentUser = JSON.parse(user);
    }

    // Load menu items
    async function loadMenu() {
        try {
            const response = await fetch(`${API_BASE_URL}/menu`);
            const data = await response.json();
            if (data.success) {
                menuItems = data.items;
                filteredItems = [...menuItems];
                renderMenu();
            }
        } catch (error) {
            console.error('Error loading menu:', error);
        }
    }

    function renderMenu() {
        const menuGrid = document.getElementById('menuGrid');

        if (filteredItems.length === 0) {
            menuGrid.innerHTML = `
                <div class="no-results">
                    <div class="no-results-icon">üîç</div>
                    <h3>Kh√¥ng t√¨m th·∫•y m√≥n ƒÉn n√†o</h3>
                    <p>H√£y th·ª≠ thay ƒë·ªïi t·ª´ kh√≥a t√¨m ki·∫øm ho·∫∑c b·ªô l·ªçc</p>
                </div>
            `;
            return;
        }

        menuGrid.innerHTML = filteredItems.map(item => `
            <div class="menu-item" onclick="addToCart(${item.id}, '${item.name}', ${item.price})">
                ${item.badge ? `<div class="item-badge ${item.badge}">${item.badge === 'popular' ? 'üî• B√°n ch·∫°y' : 'üÜï M·ªõi'}</div>` : ''}
                <img src="http://localhost:5000/${item.image}" alt="${item.name}">
                <div class="item-content">
                    <div class="item-header">
                        <div>
                            <div class="item-name">${item.name}</div>
                            <div class="item-restaurant">üìç ${item.restaurant}</div>
                            <div class="item-rating">
                                <span class="stars">${'‚≠ê'.repeat(Math.floor(item.rating))}</span>
                                <span class="rating-text">${item.rating} (${item.reviews} ƒë√°nh gi√°)</span>
                            </div>
                        </div>
                    </div>
                    <div class="item-description">${item.description}</div>
                    <div class="item-details">
                        <div class="delivery-time">‚è∞ ${item.delivery_time} ph√∫t</div>
                        <div class="delivery-distance">üìç ${item.distance}km</div>
                    </div>
                    <div class="item-footer">
                        <div class="item-price">${item.price.toLocaleString('vi-VN')} ‚Ç´</div>
                        <button class="add-btn" onclick="event.stopPropagation(); addToCart(${item.id}, '${item.name}', ${item.price})">
                            ‚ûï Th√™m
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function filterAndSort() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const distanceFilter = document.getElementById('distanceFilter').value;
        const sortFilter = document.getElementById('sortFilter').value;
        const priceFilter = document.getElementById('priceFilter').value;
        const ratingFilter = document.getElementById('ratingFilter').value;

        // Filter by search term
        filteredItems = menuItems.filter(item =>
            item.name.toLowerCase().includes(searchTerm) ||
            item.restaurant.toLowerCase().includes(searchTerm) ||
            item.description.toLowerCase().includes(searchTerm)
        );

        // Filter by distance
        if (distanceFilter) {
            filteredItems = filteredItems.filter(item => {
                switch (distanceFilter) {
                    case 'near': return item.distance < 2;
                    case 'medium': return item.distance >= 2 && item.distance <= 5;
                    case 'far': return item.distance > 5;
                    default: return true;
                }
            });
        }

        // Filter by price
        if (priceFilter) {
            filteredItems = filteredItems.filter(item => {
                switch (priceFilter) {
                    case 'budget': return item.price < 200000;
                    case 'medium': return item.price >= 200000 && item.price <= 400000;
                    case 'premium': return item.price > 400000;
                    default: return true;
                }
            });
        }

        // Filter by rating
        if (ratingFilter) {
            const minRating = parseInt(ratingFilter);
            filteredItems = filteredItems.filter(item => item.rating >= minRating);
        }

        // Sort items
        filteredItems.sort((a, b) => {
            switch (sortFilter) {
                case 'popular':
                    return b.reviews - a.reviews;
                case 'rating':
                    return b.rating - a.rating;
                case 'price-low':
                    return a.price - b.price;
                case 'price-high':
                    return b.price - a.price;
                case 'distance':
                    return a.distance - b.distance;
                default:
                    return 0;
            }
        });

        renderMenu();
    }

    async function addToCart(itemId, itemName, price) {
        try {
            const response = await fetch(`${API_BASE_URL}/cart`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUser.id,
                    item_id: itemId,
                    quantity: 1
                })
            });

            const data = await response.json();
            if (data.success) {
                alert(`üéâ ${itemName} ƒë√£ ƒë∆∞·ª£c th√™m v√†o gi·ªè h√†ng!\nGi√°: ${price.toLocaleString('vi-VN')} ‚Ç´`);
            } else {
                alert(data.message);
            }
        } catch (error) {
            alert('L·ªói khi th√™m v√†o gi·ªè h√†ng');
        }
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', filterAndSort);
    document.getElementById('distanceFilter').addEventListener('change', filterAndSort);
    document.getElementById('sortFilter').addEventListener('change', filterAndSort);
    document.getElementById('priceFilter').addEventListener('change', filterAndSort);
    document.getElementById('ratingFilter').addEventListener('change', filterAndSort);

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        checkAuth();
        loadMenu();
    });
</script>