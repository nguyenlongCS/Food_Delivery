<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Th·ª±c ƒê∆°n - Food Delivery</title>
<link rel="stylesheet" href="menu.css">
</head>
<body>
<div class="header">
    <div class="header-content">
        <h1>üçΩÔ∏è Th·ª±c ƒê∆°n ƒê·∫ßy ƒê·ªß</h1>
        <div class="header-buttons">
            <button id="addMenuBtn" class="add-menu-btn" style="display:none;">‚ûï ƒêƒÉng M√≥n</button>
            <a href="home.html" class="back-btn">‚Üê Quay L·∫°i</a>
        </div>
    </div>
</div>

<div class="container">
    <div class="menu-controls">
        <div class="search-section">
            <div class="search-icon">üîç</div>
            <input type="text" class="search-box" id="searchInput" placeholder="T√¨m ki·∫øm m√≥n ƒÉn, nh√† h√†ng...">
        </div>

        <div class="filters">
            <div class="filter-group">
                <label class="filter-label">Kho·∫£ng c√°ch</label>
                <select class="filter-select" id="distanceFilter">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="near">G·∫ßn nh·∫•t (< 2km)</option>
                    <option value="medium">Trung b√¨nh (2-5km)</option>
                    <option value="far">Xa (> 5km)</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">S·∫Øp x·∫øp</label>
                <select class="filter-select" id="sortFilter">
                    <option value="popular">B√°n ch·∫°y</option>
                    <option value="rating">ƒê√°nh gi√° cao</option>
                    <option value="price-low">Gi√° th·∫•p ‚Üí cao</option>
                    <option value="price-high">Gi√° cao ‚Üí th·∫•p</option>
                    <option value="distance">Kho·∫£ng c√°ch</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Gi√°</label>
                <select class="filter-select" id="priceFilter">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="budget">Ti·∫øt ki·ªám (< 200k)</option>
                    <option value="medium">Trung b√¨nh (200k-400k)</option>
                    <option value="premium">Cao c·∫•p (> 400k)</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">ƒê√°nh gi√°</label>
                <select class="filter-select" id="ratingFilter">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê+ tr·ªü l√™n</option>
                    <option value="3">‚≠ê‚≠ê‚≠ê+ tr·ªü l√™n</option>
                </select>
            </div>
        </div>
    </div>

    <div class="menu-grid" id="menuGrid">
        <!-- Menu items will be loaded here -->
    </div>
</div>

<!-- Modal ƒëƒÉng m√≥n -->
<div id="addMenuModal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìù ƒêƒÉng M√≥n ƒÇn M·ªõi</h2>
            <span class="close">&times;</span>
        </div>
        <form id="addMenuForm" enctype="multipart/form-data">
            <div class="form-row">
                <div class="form-group">
                    <label>T√™n m√≥n ƒÉn *</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Gi√° (VND) *</label>
                    <input type="number" name="price" min="1000" required>
                </div>
            </div>

            <div class="form-group">
                <label>M√¥ t·∫£ m√≥n ƒÉn</label>
                <textarea name="description" rows="3"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Danh m·ª•c</label>
                    <select name="category">
                        <option value="vietnamese">Vi·ªát Nam</option>
                        <option value="pizza">Pizza</option>
                        <option value="burger">Burger</option>
                        <option value="sushi">Sushi</option>
                        <option value="chicken">G√†</option>
                        <option value="pasta">Pasta</option>
                        <option value="japanese">Nh·∫≠t B·∫£n</option>
                        <option value="other">Kh√°c</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Th·ªùi gian giao (ph√∫t)</label>
                    <input type="number" name="delivery_time" value="30" min="10" max="120">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Kho·∫£ng c√°ch (km)</label>
                    <input type="number" name="distance" value="1.0" min="0.1" max="50" step="0.1">
                </div>
                <div class="form-group">
                    <label>Badge</label>
                    <select name="badge">
                        <option value="">Kh√¥ng</option>
                        <option value="popular">üî• B√°n ch·∫°y</option>
                        <option value="new">üÜï M·ªõi</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>H√¨nh ·∫£nh m√≥n ƒÉn *</label>
                <input type="file" name="image" accept="image/*" required>
                <div class="image-preview" id="imagePreview"></div>
            </div>

            <div class="form-actions">
                <button type="button" class="cancel-btn">H·ªßy</button>
                <button type="submit" class="submit-btn">üçΩÔ∏è ƒêƒÉng M√≥n</button>
            </div>
        </form>
    </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:5000/api';
    let menuItems = [];
    let filteredItems = [];
    let currentUser = null;

    // Check authentication
    function checkAuth() {
        const user = localStorage.getItem('user');
        if (!user) {
            window.location.href = 'index.html';
            return;
        }
        currentUser = JSON.parse(user);

        // Hi·ªÉn th·ªã n√∫t ƒëƒÉng m√≥n n·∫øu l√† restaurant
        if (currentUser.role === 'restaurant') {
            document.getElementById('addMenuBtn').style.display = 'block';
        }
    }

    // Load menu items
    async function loadMenu() {
        try {
            const response = await fetch(`${API_BASE_URL}/menu`);
            const data = await response.json();
            if (data.success) {
                menuItems = data.items;
                filteredItems = [...menuItems];
                renderMenu();
            }
        } catch (error) {
            console.error('Error loading menu:', error);
        }
    }

    function renderMenu() {
        const menuGrid = document.getElementById('menuGrid');

        if (filteredItems.length === 0) {
            menuGrid.innerHTML = `
                <div class="no-results">
                    <div class="no-results-icon">üîç</div>
                    <h3>Kh√¥ng t√¨m th·∫•y m√≥n ƒÉn n√†o</h3>
                    <p>H√£y th·ª≠ thay ƒë·ªïi t·ª´ kh√≥a t√¨m ki·∫øm ho·∫∑c b·ªô l·ªçc</p>
                </div>
            `;
            return;
        }

        menuGrid.innerHTML = filteredItems.map(item => `
            <div class="menu-item" onclick="addToCart(${item.id}, '${item.name}', ${item.price})">
                ${item.badge ? `<div class="item-badge ${item.badge}">${item.badge === 'popular' ? 'üî• B√°n ch·∫°y' : 'üÜï M·ªõi'}</div>` : ''}
                <img src="http://localhost:5000/${item.image}" alt="${item.name}">
                <div class="item-content">
                    <div class="item-header">
                        <div>
                            <div class="item-name">${item.name}</div>
                            <div class="item-restaurant">üè™ ${item.restaurant}</div>
                            <div class="item-rating">
                                <span class="stars">${'‚≠ê'.repeat(Math.floor(item.rating))}</span>
                                <span class="rating-text">${item.rating} (${item.reviews} ƒë√°nh gi√°)</span>
                            </div>
                        </div>
                    </div>
                    <div class="item-description">${item.description}</div>
                    <div class="item-details">
                        <div class="delivery-time">‚è∞ ${item.delivery_time} ph√∫t</div>
                        <div class="delivery-distance">üìç ${item.distance}km</div>
                    </div>
                    <div class="item-footer">
                        <div class="item-price">${item.price.toLocaleString('vi-VN')} ‚Ç´</div>
                        <button class="add-btn" onclick="event.stopPropagation(); addToCart(${item.id}, '${item.name}', ${item.price})">
                            ‚ûï Th√™m
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function filterAndSort() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const distanceFilter = document.getElementById('distanceFilter').value;
        const sortFilter = document.getElementById('sortFilter').value;
        const priceFilter = document.getElementById('priceFilter').value;
        const ratingFilter = document.getElementById('ratingFilter').value;

        // Filter by search term
        filteredItems = menuItems.filter(item =>
            item.name.toLowerCase().includes(searchTerm) ||
            item.restaurant.toLowerCase().includes(searchTerm) ||
            item.description.toLowerCase().includes(searchTerm)
        );

        // Filter by distance
        if (distanceFilter) {
            filteredItems = filteredItems.filter(item => {
                switch (distanceFilter) {
                    case 'near': return item.distance < 2;
                    case 'medium': return item.distance >= 2 && item.distance <= 5;
                    case 'far': return item.distance > 5;
                    default: return true;
                }
            });
        }

        // Filter by price
        if (priceFilter) {
            filteredItems = filteredItems.filter(item => {
                switch (priceFilter) {
                    case 'budget': return item.price < 200000;
                    case 'medium': return item.price >= 200000 && item.price <= 400000;
                    case 'premium': return item.price > 400000;
                    default: return true;
                }
            });
        }

        // Filter by rating
        if (ratingFilter) {
            const minRating = parseInt(ratingFilter);
            filteredItems = filteredItems.filter(item => item.rating >= minRating);
        }

        // Sort items
        filteredItems.sort((a, b) => {
            switch (sortFilter) {
                case 'popular':
                    return b.reviews - a.reviews;
                case 'rating':
                    return b.rating - a.rating;
                case 'price-low':
                    return a.price - b.price;
                case 'price-high':
                    return b.price - a.price;
                case 'distance':
                    return a.distance - b.distance;
                default:
                    return 0;
            }
        });

        renderMenu();
    }

    async function addToCart(itemId, itemName, price) {
        try {
            const response = await fetch(`${API_BASE_URL}/cart`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUser.id,
                    item_id: itemId,
                    quantity: 1
                })
            });

            const data = await response.json();
            if (data.success) {
                alert(`üéâ ${itemName} ƒë√£ ƒë∆∞·ª£c th√™m v√†o gi·ªè h√†ng!\nGi√°: ${price.toLocaleString('vi-VN')} ‚Ç´`);
            } else {
                alert(data.message);
            }
        } catch (error) {
            alert('L·ªói khi th√™m v√†o gi·ªè h√†ng');
        }
    }

    // Modal functions
    function openModal() {
        document.getElementById('addMenuModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('addMenuModal').style.display = 'none';
        document.getElementById('addMenuForm').reset();
        document.getElementById('imagePreview').innerHTML = '';
    }

    // Image preview
    function handleImagePreview(event) {
        const file = event.target.files[0];
        const preview = document.getElementById('imagePreview');

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 200px; max-height: 150px; border-radius: 8px;">`;
            };
            reader.readAsDataURL(file);
        } else {
            preview.innerHTML = '';
        }
    }

    // Submit new menu item
    async function submitMenuItem(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        formData.append('restaurant', currentUser.username);

        try {
            const response = await fetch(`${API_BASE_URL}/menu`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (data.success) {
                alert('üéâ ƒêƒÉng m√≥n th√†nh c√¥ng!');
                closeModal();
                loadMenu(); // Reload menu
            } else {
                alert(data.message);
            }
        } catch (error) {
            alert('L·ªói khi ƒëƒÉng m√≥n: ' + error.message);
        }
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', filterAndSort);
    document.getElementById('distanceFilter').addEventListener('change', filterAndSort);
    document.getElementById('sortFilter').addEventListener('change', filterAndSort);
    document.getElementById('priceFilter').addEventListener('change', filterAndSort);
    document.getElementById('ratingFilter').addEventListener('change', filterAndSort);

    // Modal event listeners
    document.getElementById('addMenuBtn').addEventListener('click', openModal);
    document.querySelector('.close').addEventListener('click', closeModal);
    document.querySelector('.cancel-btn').addEventListener('click', closeModal);
    document.querySelector('input[name="image"]').addEventListener('change', handleImagePreview);
    document.getElementById('addMenuForm').addEventListener('submit', submitMenuItem);

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('addMenuModal');
        if (event.target === modal) {
            closeModal();
        }
    });

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        checkAuth();
        loadMenu();
    });
</script>